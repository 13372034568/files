nginx在1.13版本之后可以支持grpc的负载均衡

所以，如果不用docker，则需要手动下载nginx1.14.1：http://nginx.org/download/nginx-1.14.1.tar.gz
# 编译和安装nginx

解压后，进入nginx目录

执行
sudo apt-get update   
sudo apt-get install libpcre3 libpcre3-dev 
apt-get install zlib1g-dev

安装gcc
sudo apt-get  install  build-essential

安装好之后继续执行
./configure --with-http_v2_module
这里之所以加上后缀，是因为grpc在nginx中写作http2，如果不加，会报错

执行
make
make install

切到路径：/usr/local/nginx/sbin

配置软链接
sudo ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx

测试nginx配置文件是否正确
nginx -t -c /usr/local/nginx/conf/nginx.conf

启动nginx
nginx -c /usr/local/nginx/conf/nginx.conf

关闭nginx
nginx -s stop

# 从docker安装nginx
docker pull nginx， 默认安装latest

以下命令使用 NGINX 默认的配置来启动一个 Nginx 容器实例
docker run --name runoob-nginx-test -p 8081:80 -d nginx

创建目录 nginx
mkdir -p ~/nginx/conf

拷贝容器内 Nginx 默认配置文件到本地当前目录下的 conf 目录, 容器 ID 可以查看 docker ps 命令输入中的第一列
docker cp 6dd4380ba708:/etc/nginx/nginx.conf ~/nginx/conf

部署命令
docker run -d -p 8082:80 --name nginx-grpc \
-v ~/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \
nginx

# 修改nginx.conf,设置grpc负载
在http下修改两个地方
1. 因为要传图片，所以要增加client_max_body_size的设置
2. 尾部要增加新的server
http {
    ...
    keepalive_timeout  65;

	client_max_body_size 20M;

   ...
	server {
	    listen       6666 http2;
	    server_name  localhost;

	    location / {
		      grpc_pass grpc://grpcservers;
	    }
	}

	upstream grpcservers {
	    server 127.0.0.1:8000;
	    server 127.0.0.1:8001;
	    server 192.168.1.75:8000;
	    keepalive 2000;
	}

}

修改完后重新启动容器或者nginx即可，对外端口即为6666

# 测试端口


